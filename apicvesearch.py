import nvdlib
import requests
import argparse
from argparse import RawTextHelpFormatter

parser = argparse.ArgumentParser(description="api call for cve's epss\n\nusage: cvendv.py CVE-2022-26332\n\ncvendv.py CVE-2022-26332,CVE-2022-27225,CVE-2022-27223,CVE-2022-27218\n\ncvendv.py CVE-2022-26332 -d 2022-03-05\n\ncvendv.py CVE-2022-26332,CVE-2022-27225 -d 2022-02-09\n", formatter_class=RawTextHelpFormatter)
parser.add_argument('cve', metavar='cve', type=str, help='enter your target cve')   
parser.add_argument('-d', action='store', default="", type=str, help='enter search date')
parser.add_argument('-f', action='store', default=False)

args = parser.parse_args()
cve = args.cve
date_search = args.d
filename = args.f

def main(cve, date_search):

    file_content = ""

    if "," in cve:

        cves = cve.split(",")

    else:

        cves = [cve]

    for cve in cves:

        r = nvdlib.getCVE(cve)
        url = "https://api.first.org/data/v1/epss?cve=" + cve

        if date_search:

            url += "&date=" + date_search

        payload={}
        headers = {}

        response = requests.request("GET", url, headers=headers, data=payload)

        if response.json()['data']:
            file_content += (f"\nCVE: {response.json()['data'][0]['cve']}\n") + (f"\nSeverity: {r.v3severity + ' - ' + str(r.v3score)}\n") + (f"\nEPSS: {response.json()['data'][0]['epss']}\n") + (f"\nPercentile: {response.json()['data'][0]['percentile']}\n") +(f"\nDate: {response.json()['data'][0]['date']}\n") + (f"\nExploitability Score:{r.impact.baseMetricV3.exploitabilityScore}\n") + (f"\nImpact Score:{r.impact.baseMetricV3.impactScore}\n") + ("\nReferences\n")
            references = r.cve.references.reference_data
            for ref in references:

                file_content += (ref.url + "\n")
            file_content+="\n"
        else:
            file_content += (f"\n{cve}\n") + (f"\nExploitability Score:{r.impact.baseMetricV3.exploitabilityScore}\n") + (f"Impact Score:{r.impact.baseMetricV3.impactScore}\n") + (f"Severity {r.impact.baseMetricV3.cvssV3.baseSeverity} - {r.impact.baseMetricV3.cvssV3.baseScore}\n") + (f"not many useful information was found using the date parameter in this specific case, give only the CVEs instead\n")           

        cvss_dict = {

            "AV": "Attack Vector",
            "AC": "Attack Complexity",
            "PR": "Privileges Required",
            "UI": "User Interaction",
            "S": "Scope",
            "C": "Confidentiality",
            "I": "Integrity",
            "A": "Availability"
        }

        cvss_classification_dict = {


            "AV": {"N": "Network", "A": "Adjacent", "L": "Local", "P": "Physical",},
            "AC": {"L": "Low", "H": "High"},    
            "PR": {"N": "None", "L": "Low", "H": "High"},
            "UI": {"N": "None", "R": "Required"},
            "S": {"U": "Unchanged", "C": "Changed"},
            "C": {"N":"None", "L":"Low", "H": "High"},
            "I": {"N":"None", "L":"Low", "H": "High"},
            "A": {"N":"None", "L":"Low", "H": "High"}

        }

        cvss = r.v3vector.split("/")
        
        for score in cvss:

            if "CVSS" in score:
                file_content += ("\n" + score + "\n")

            else:

                score_list = score.split(":")
                file_content += (f"\n{cvss_dict[score_list[0]]} - {cvss_classification_dict[score_list[0]][score_list[1]]}\n")
        file_content += ("\n--------------------------------------\n")
    file_content += ("\n")

    if filename:

        file = open(filename, 'a')
        file.write(file_content)
        file.close()
    
    else:

        print(file_content)

main(cve, date_search)